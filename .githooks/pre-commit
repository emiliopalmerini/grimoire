#!/usr/bin/env bash
set -euo pipefail

# Check if go.mod or go.sum are staged
if ! git diff --cached --name-only | grep -qE '^go\.(mod|sum)$'; then
    exit 0
fi

echo "go.mod/go.sum changed, updating vendorHash..."

FLAKE_FILE="flake.nix"

# Set empty hash
sed -i.bak 's/vendorHash = "sha256-[^"]*"/vendorHash = ""/' "$FLAKE_FILE"

# Build and capture hash
HASH=$(nix build .#default 2>&1 | grep "got:" | awk '{print $2}')

if [ -z "$HASH" ]; then
    echo "Failed to get vendorHash, restoring backup"
    mv "$FLAKE_FILE.bak" "$FLAKE_FILE"
    exit 1
fi

# Update with correct hash
sed -i '' "s|vendorHash = \"\"|vendorHash = \"$HASH\"|" "$FLAKE_FILE"
rm -f "$FLAKE_FILE.bak"

echo "Updated vendorHash to: $HASH"

# Stage the updated flake.nix
git add "$FLAKE_FILE"
